<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vue 渲染更新源码解析 | MrZhao&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/assets/logo.jpg">
    <meta name="description" content="个人博客">
    
    <link rel="preload" href="/assets/css/0.styles.ddf5beda.css" as="style"><link rel="preload" href="/assets/js/app.acb235b1.js" as="script"><link rel="preload" href="/assets/js/2.d372d77b.js" as="script"><link rel="preload" href="/assets/js/1.37fa4b6c.js" as="script"><link rel="preload" href="/assets/js/114.ffe9fe06.js" as="script"><link rel="prefetch" href="/assets/js/10.82b2071b.js"><link rel="prefetch" href="/assets/js/100.e63403ed.js"><link rel="prefetch" href="/assets/js/101.f5129fd2.js"><link rel="prefetch" href="/assets/js/102.d0ddf2d8.js"><link rel="prefetch" href="/assets/js/103.9926bfcb.js"><link rel="prefetch" href="/assets/js/104.af476e27.js"><link rel="prefetch" href="/assets/js/105.c8937ef6.js"><link rel="prefetch" href="/assets/js/106.1397eb8d.js"><link rel="prefetch" href="/assets/js/107.9afde75e.js"><link rel="prefetch" href="/assets/js/108.cb71564c.js"><link rel="prefetch" href="/assets/js/109.367dbeed.js"><link rel="prefetch" href="/assets/js/11.4dba772f.js"><link rel="prefetch" href="/assets/js/110.49f4bab3.js"><link rel="prefetch" href="/assets/js/111.5d4c672e.js"><link rel="prefetch" href="/assets/js/112.edc0db73.js"><link rel="prefetch" href="/assets/js/113.9852316c.js"><link rel="prefetch" href="/assets/js/115.564724ca.js"><link rel="prefetch" href="/assets/js/116.5cd792a1.js"><link rel="prefetch" href="/assets/js/117.4b4aaf18.js"><link rel="prefetch" href="/assets/js/118.6888441c.js"><link rel="prefetch" href="/assets/js/119.b8950c5c.js"><link rel="prefetch" href="/assets/js/12.27965b5f.js"><link rel="prefetch" href="/assets/js/120.c92b4b7a.js"><link rel="prefetch" href="/assets/js/121.0d5986c2.js"><link rel="prefetch" href="/assets/js/122.e54d395a.js"><link rel="prefetch" href="/assets/js/123.7de3e59a.js"><link rel="prefetch" href="/assets/js/124.aec1c47d.js"><link rel="prefetch" href="/assets/js/125.12be05e6.js"><link rel="prefetch" href="/assets/js/13.4895e118.js"><link rel="prefetch" href="/assets/js/14.efee2099.js"><link rel="prefetch" href="/assets/js/15.08f58c28.js"><link rel="prefetch" href="/assets/js/16.e25cce72.js"><link rel="prefetch" href="/assets/js/17.73af3b17.js"><link rel="prefetch" href="/assets/js/18.a5cd26c5.js"><link rel="prefetch" href="/assets/js/19.5b5def25.js"><link rel="prefetch" href="/assets/js/20.9ae07869.js"><link rel="prefetch" href="/assets/js/21.1f0d465b.js"><link rel="prefetch" href="/assets/js/22.0e74832d.js"><link rel="prefetch" href="/assets/js/23.7d3158db.js"><link rel="prefetch" href="/assets/js/24.83abb9ba.js"><link rel="prefetch" href="/assets/js/25.c853c4de.js"><link rel="prefetch" href="/assets/js/26.e4ede223.js"><link rel="prefetch" href="/assets/js/27.3b00c66b.js"><link rel="prefetch" href="/assets/js/28.123c02f0.js"><link rel="prefetch" href="/assets/js/29.981e7943.js"><link rel="prefetch" href="/assets/js/3.5e61bf8f.js"><link rel="prefetch" href="/assets/js/30.47d8c561.js"><link rel="prefetch" href="/assets/js/31.b0370337.js"><link rel="prefetch" href="/assets/js/32.f5639ab2.js"><link rel="prefetch" href="/assets/js/33.4d982e7e.js"><link rel="prefetch" href="/assets/js/34.476ca9ee.js"><link rel="prefetch" href="/assets/js/35.d6c54e1c.js"><link rel="prefetch" href="/assets/js/36.bb6f614a.js"><link rel="prefetch" href="/assets/js/37.a8ecfac1.js"><link rel="prefetch" href="/assets/js/38.e7d16fe5.js"><link rel="prefetch" href="/assets/js/39.7dc7f49e.js"><link rel="prefetch" href="/assets/js/4.30f14711.js"><link rel="prefetch" href="/assets/js/40.d05cfc3c.js"><link rel="prefetch" href="/assets/js/41.38899e70.js"><link rel="prefetch" href="/assets/js/42.0b533d65.js"><link rel="prefetch" href="/assets/js/43.53d193d3.js"><link rel="prefetch" href="/assets/js/44.3b96fad7.js"><link rel="prefetch" href="/assets/js/45.eef657e9.js"><link rel="prefetch" href="/assets/js/46.b2f1fd36.js"><link rel="prefetch" href="/assets/js/47.9c09556d.js"><link rel="prefetch" href="/assets/js/48.ce176bc3.js"><link rel="prefetch" href="/assets/js/49.f55f1fca.js"><link rel="prefetch" href="/assets/js/5.756b6e8a.js"><link rel="prefetch" href="/assets/js/50.beb1776a.js"><link rel="prefetch" href="/assets/js/51.d31795c1.js"><link rel="prefetch" href="/assets/js/52.19761715.js"><link rel="prefetch" href="/assets/js/53.cf691bec.js"><link rel="prefetch" href="/assets/js/54.69111173.js"><link rel="prefetch" href="/assets/js/55.6a5031d0.js"><link rel="prefetch" href="/assets/js/56.a6d0b60c.js"><link rel="prefetch" href="/assets/js/57.9a437f90.js"><link rel="prefetch" href="/assets/js/58.8f3c8e43.js"><link rel="prefetch" href="/assets/js/59.dc73bd90.js"><link rel="prefetch" href="/assets/js/6.c6e8dcba.js"><link rel="prefetch" href="/assets/js/60.8431e9e8.js"><link rel="prefetch" href="/assets/js/61.31a7a75b.js"><link rel="prefetch" href="/assets/js/62.a78d06bf.js"><link rel="prefetch" href="/assets/js/63.b40afbd7.js"><link rel="prefetch" href="/assets/js/64.cb8ba378.js"><link rel="prefetch" href="/assets/js/65.608bc3be.js"><link rel="prefetch" href="/assets/js/66.c430f2d9.js"><link rel="prefetch" href="/assets/js/67.96a5041b.js"><link rel="prefetch" href="/assets/js/68.d152d1b8.js"><link rel="prefetch" href="/assets/js/69.54bd8d5c.js"><link rel="prefetch" href="/assets/js/7.b18f4475.js"><link rel="prefetch" href="/assets/js/70.d10c0bb6.js"><link rel="prefetch" href="/assets/js/71.1b530077.js"><link rel="prefetch" href="/assets/js/72.76b37ee5.js"><link rel="prefetch" href="/assets/js/73.1d72d0ea.js"><link rel="prefetch" href="/assets/js/74.136395b3.js"><link rel="prefetch" href="/assets/js/75.163b827e.js"><link rel="prefetch" href="/assets/js/76.29c6b42d.js"><link rel="prefetch" href="/assets/js/77.ce9ee614.js"><link rel="prefetch" href="/assets/js/78.299f9cda.js"><link rel="prefetch" href="/assets/js/79.fe755e03.js"><link rel="prefetch" href="/assets/js/80.1884cea8.js"><link rel="prefetch" href="/assets/js/81.68edf7ac.js"><link rel="prefetch" href="/assets/js/82.a4b444d1.js"><link rel="prefetch" href="/assets/js/83.055b0579.js"><link rel="prefetch" href="/assets/js/84.6d10a5cc.js"><link rel="prefetch" href="/assets/js/85.56cc70f5.js"><link rel="prefetch" href="/assets/js/86.46400f67.js"><link rel="prefetch" href="/assets/js/87.0e8035e0.js"><link rel="prefetch" href="/assets/js/88.e86cd82a.js"><link rel="prefetch" href="/assets/js/89.1115943f.js"><link rel="prefetch" href="/assets/js/90.1ec59b21.js"><link rel="prefetch" href="/assets/js/91.92c56bfd.js"><link rel="prefetch" href="/assets/js/92.98f06763.js"><link rel="prefetch" href="/assets/js/93.efccb64b.js"><link rel="prefetch" href="/assets/js/94.bd47fc37.js"><link rel="prefetch" href="/assets/js/95.1aedc256.js"><link rel="prefetch" href="/assets/js/96.f7ec82ea.js"><link rel="prefetch" href="/assets/js/97.1903528c.js"><link rel="prefetch" href="/assets/js/98.b1d996fc.js"><link rel="prefetch" href="/assets/js/99.a7062bf9.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.cc58001a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ddf5beda.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">MrZhao's blog</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端基础" class="dropdown-title"><span class="title">前端基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端基础" class="mobile-dropdown-title"><span class="title">前端基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/feBase/js/" class="nav-link">
  Javascript
</a></li><li class="dropdown-item"><!----> <a href="/ES6/base.html" class="nav-link">
  ES6
</a></li><li class="dropdown-item"><!----> <a href="/feBase/css/1.html" class="nav-link">
  Css
</a></li><li class="dropdown-item"><!----> <a href="/feBase/browser/1.html" class="nav-link">
  浏览器
</a></li><li class="dropdown-item"><!----> <a href="/feBase/mini/1.html" class="nav-link">
  小程序
</a></li><li class="dropdown-item"><!----> <a href="/vue/" class="nav-link router-link-active">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/react/1.html" class="nav-link">
  React
</a></li><li class="dropdown-item"><!----> <a href="/ssr/" class="nav-link">
  SSR
</a></li><li class="dropdown-item"><!----> <a href="/cloudflare/tunnel.html" class="nav-link">
  Cloudflare
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="打包工具" class="dropdown-title"><span class="title">打包工具</span> <span class="arrow down"></span></button> <button type="button" aria-label="打包工具" class="mobile-dropdown-title"><span class="title">打包工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/webpack/base.html" class="nav-link">
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/rollup/base.html" class="nav-link">
  Rollup
</a></li></ul></div></div><div class="nav-item"><a href="/node/" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/leetcode/array.html" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/test/" class="nav-link">
  常见问题
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端基础" class="dropdown-title"><span class="title">前端基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端基础" class="mobile-dropdown-title"><span class="title">前端基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/feBase/js/" class="nav-link">
  Javascript
</a></li><li class="dropdown-item"><!----> <a href="/ES6/base.html" class="nav-link">
  ES6
</a></li><li class="dropdown-item"><!----> <a href="/feBase/css/1.html" class="nav-link">
  Css
</a></li><li class="dropdown-item"><!----> <a href="/feBase/browser/1.html" class="nav-link">
  浏览器
</a></li><li class="dropdown-item"><!----> <a href="/feBase/mini/1.html" class="nav-link">
  小程序
</a></li><li class="dropdown-item"><!----> <a href="/vue/" class="nav-link router-link-active">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/react/1.html" class="nav-link">
  React
</a></li><li class="dropdown-item"><!----> <a href="/ssr/" class="nav-link">
  SSR
</a></li><li class="dropdown-item"><!----> <a href="/cloudflare/tunnel.html" class="nav-link">
  Cloudflare
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="打包工具" class="dropdown-title"><span class="title">打包工具</span> <span class="arrow down"></span></button> <button type="button" aria-label="打包工具" class="mobile-dropdown-title"><span class="title">打包工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/webpack/base.html" class="nav-link">
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/rollup/base.html" class="nav-link">
  Rollup
</a></li></ul></div></div><div class="nav-item"><a href="/node/" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/leetcode/array.html" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/test/" class="nav-link">
  常见问题
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Vue</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue/" aria-current="page" class="sidebar-link">Vue核心</a></li><li><a href="/vue/1.html" class="sidebar-link">Vue常用</a></li><li><a href="/vue/2.html" class="sidebar-link">Vue路由</a></li><li><a href="/vue/3.html" class="sidebar-link">Vue组件</a></li><li><a href="/vue/defineReactive.html" class="sidebar-link">Vue 响应式数据源码解析</a></li><li><a href="/vue/render.html" class="sidebar-link">Vue 模板编译源码解析</a></li><li><a href="/vue/mount.html" class="sidebar-link">Vue 初始化渲染源码解析</a></li><li><a href="/vue/observer.html" aria-current="page" class="active sidebar-link">Vue 渲染更新源码解析</a></li><li><a href="/vue/nextTick.html" class="sidebar-link">Vue 异步更新源码解析</a></li><li><a href="/vue/watch.html" class="sidebar-link">Vue 侦听器(watch)源码解析</a></li><li><a href="/vue/computed.html" class="sidebar-link">Vue 计算属性(computed)源码解析</a></li><li><a href="/vue/lifecycle.html" class="sidebar-link">Vue 生命周期源码解析</a></li><li><a href="/vue/domdiff.html" class="sidebar-link">Vue DOMdiff(patch)源码解析</a></li><li><a href="/vue/vuex.html" class="sidebar-link">Vuex源码解析</a></li><li><a href="/vue/seo.html" class="sidebar-link">Vue首屏渲染优化与SEO</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p></p><div class="table-of-contents"><ul><li><a href="#声明watcher类">声明Watcher类</a></li><li><a href="#创建渲染watcher">创建渲染watcher</a></li><li><a href="#声明存放watcher的dep类">声明存放watcher的Dep类</a></li><li><a href="#依赖收集">依赖收集</a></li><li><a href="#更新watcher类">更新Watcher类</a></li><li><a href="#更新dep类">更新Dep类</a></li><li><a href="#数组的依赖收集-observer升级">数组的依赖收集(Observer升级)</a></li><li><a href="#数组的派发更新">数组的派发更新</a></li><li><a href="#对象新增属性的响应式原理">对象新增属性的响应式原理</a></li></ul></div><p></p> <h1 id="vue-渲染更新源码解析"><a href="#vue-渲染更新源码解析" class="header-anchor">#</a> Vue 渲染更新源码解析</h1> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>此篇主要讲了Vue的数据驱动是怎么实现的，如何采用观察者模式，将数据改变和视图更新绑定在一起的，数据更改后，自动更新视图。</p></div> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  {{name}}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">el</span><span class="token operator">:</span> <span class="token string">&quot;#app&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;mrzhao&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;zhongguo&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">// 需要手动更新视图 （目前还没有diff）</span>
    vm<span class="token punctuation">.</span><span class="token function">_update</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">_render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>上一篇讲完了首次渲染，<code>_update</code>就是更新视图的核心方法，数据再次更改时，我们需要手动调用<code>vm._update(vm._render());</code>来更新视图。此篇就是讲解通过观察者模式，在更改完数据后，自动触发视图更新。</p></div> <h2 id="声明watcher类"><a href="#声明watcher类" class="header-anchor">#</a> 声明Watcher类</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/observer/watcher.js</span>

<span class="token comment">// watcher的唯一id 每个watcher实例都有，根据数量递增，</span>
<span class="token keyword">let</span> id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Watcher</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> exprOrFn<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vm <span class="token operator">=</span> vm<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options<span class="token punctuation">;</span> <span class="token comment">//额外的选项 true代表渲染watcher</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">=</span> cb<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>exprOrFn <span class="token operator">=</span> exprOrFn<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// watcher的唯一标识</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> exprOrFn<span class="token punctuation">;</span>
    <span class="token comment">// 初始化watcher会让getter执行</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 方便扩展</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Watcher</p> <p>Vue采用观察者模式来实现数据变化后，驱动视图更新。watcher的作用就是数据变化后，执行相应的回调函数从而更新视图的。当数据初始化时取值时，会收集当前的渲染<code>watcher</code>，数据变化之后，通知渲染<code>watcher</code>更新视图。</p></div> <h2 id="创建渲染watcher"><a href="#创建渲染watcher" class="header-anchor">#</a> 创建渲染watcher</h2> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>更新<code>mountComponent</code>方法，将</p></div> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/lifecycle.js</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">mountComponent</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 修改为观察者模式，生成渲染watcher</span>

  <span class="token keyword">let</span> <span class="token function-variable function">updateComponent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span><span class="token function">_update</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">_render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 最后一个参数为 true 代表是渲染watcher</span>
  <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> updateComponent<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'更新视图了'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="声明存放watcher的dep类"><a href="#声明存放watcher的dep类" class="header-anchor">#</a> 声明存放watcher的Dep类</h2> <div class="custom-block tip"><p class="custom-block-title">Dep</p> <p>因为一个属性可能有多个地方使用比如在<code>Computed</code>中使用，在<code>watch</code>方法中使用，所以可能有多个<code>watcher</code>，这样每个属性就需要有一个自己收集<code>watcher</code>的地方，我们通过声明<code>Dep</code>类，来收集<code>watcher</code>。</p></div> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/observer/dep.js</span>

<span class="token comment">// 每个属性有一个dep，dep可以来存放watcher</span>
<span class="token keyword">let</span> id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Dep</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 存放watcher</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Dep类的静态属性，只有一个</span>
Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">pushTarget</span><span class="token punctuation">(</span><span class="token parameter">watcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> watcher<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">popTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> Dep<span class="token punctuation">;</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Dep</p> <p><code>Dep</code>类用来收集<code>watcher</code>，存入<code>subs</code>中，当有属性更新时，会调用方法循环<code>subs</code>，依次执行每个<code>watcher</code>的更新方法，做对应的更新。</p></div> <h2 id="依赖收集"><a href="#依赖收集" class="header-anchor">#</a> 依赖收集</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/observer/index.js</span>

<span class="token comment">// 响应式数据核心方法 defineReactive</span>
<span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">observe</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 每次都会给属性创建一个dep  </span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 对属性取值的时候 会走get方法，把watcher收集到dep里面--依赖收集</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果有watcher dep就会保存watcher 同时watcher也会保存dep</span>
        dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">set</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>newValue <span class="token operator">===</span> value<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token comment">// 如果赋值的新值也是一个对象  需要观测</span>
      <span class="token function">observe</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
      value <span class="token operator">=</span> newValue<span class="token punctuation">;</span>
      <span class="token comment">// 当属性更新的时候，会走set方法，需要告诉当前的属性存放的watcher执行</span>
      dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="更新watcher类"><a href="#更新watcher类" class="header-anchor">#</a> 更新Watcher类</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/observer/watcher.js</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> pushTarget<span class="token punctuation">,</span> popTarget <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./dep&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// watcher实例的id  每次new Watcher都会自增</span>
<span class="token keyword">let</span> id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Watcher</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> exprOrFn<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// this.vm = vm;</span>
    <span class="token comment">// this.exprOrFn = exprOrFn;</span>
    <span class="token comment">// this.cb = cb;</span>
    <span class="token comment">// this.options = options;</span>
    <span class="token comment">// this.id = id++; </span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
    <span class="token keyword">this</span><span class="token punctuation">.</span>depsId <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//用来去重dep</span>

    <span class="token comment">// this.getter = exprOrFn;</span>
    <span class="token comment">// 实例化就会默认调用get方法</span>
    <span class="token comment">// this.get();</span>
  <span class="token punctuation">}</span>
  <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在调用getter之前先把当前watcher实例放在Dep.target上</span>
    <span class="token function">pushTarget</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果是渲染watcher 那么就相当于执行 vm._update(vm._render())，这个方法在render函数执行的时候会去vm上取属性值，就会触发definedReactive的get方法，Dep.target上有值，就会做依赖收集</span>
    <span class="token comment">// this.getter();</span>
    <span class="token comment">// 之后重置Dep.target属性的值</span>
    <span class="token function">popTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
  <span class="token comment">//  把dep放到deps里面 同时做去重处理，同样的  同一个watcher也只会保存在dep一次</span>
  <span class="token function">addDep</span><span class="token punctuation">(</span><span class="token parameter">dep</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> id <span class="token operator">=</span> dep<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>depsId<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>depsId<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//  直接调用dep的addSub方法  把当前watcher实例添加到dep的subs容器中</span>
      dep<span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 数据更新之后，会循环执行watcher，执行update方法，更新视图。</span>
  <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="更新dep类"><a href="#更新dep类" class="header-anchor">#</a> 更新Dep类</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/observer/dep.js</span>


<span class="token keyword">let</span> id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Dep</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 存放watcher</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// definedReactive的get方法中会调用此方法</span>
  <span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Dep.target有值时代表有watcher，需要做双向收集</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// watcher的addDep会做去重处理，</span>
      Dep<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">addDep</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 收集watcher</span>
  <span class="token function">addSub</span><span class="token punctuation">(</span><span class="token parameter">watcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>watcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 数据更新时会调用，循环watcher执行update方法</span>
  <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">watcher</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> watcher<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Dep类的静态属性，只有一个</span>
<span class="token comment">/* 
Dep.target = null;

export function pushTarget(watcher) {
  Dep.target = watcher;
}

export function popTarget() {
  Dep.target = null;
}
 */</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> Dep<span class="token punctuation">;</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>此时对象的依赖收集已经完成了，但是对于数组类型的值，走的不是<code>defineReactive</code>方法，所以还需要对数组类型的数据做额外的处理，让数组也进行依赖收集。</p></div> <h2 id="数组的依赖收集-observer升级"><a href="#数组的依赖收集-observer升级" class="header-anchor">#</a> 数组的依赖收集(Observer升级)</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/observer/index.js</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> isObject <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../utils&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Dep <span class="token keyword">from</span> <span class="token string">&quot;./dep&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Observer</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 需要给数组和对象本身的Observer实例增加一个dep，用于做依赖收集和派发更新</span>
    <span class="token comment">// $set给对象定义响应式的时候，触发一次更新也会用到。</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  
    <span class="token comment">/* 
    Object.defineProperty(data, &quot;__ob__&quot;, {
      value: this,
      enumerable: false, // 不可枚举的
    });
    if (Array.isArray(data)) {
      data.__proto__ = arrayMethods;
      this.observeArray(data);
    } else {
      this.walk(data);
    }
  }
  observeArray(data) {
    data.forEach((item) =&gt; observe(item));
  }
  walk(data) {
    Object.keys(data).forEach((key) =&gt; {
      defineReactive(data, key, data[key]);
    });
  } 
  */</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">observe</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果是对象才观测</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>__ob__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> data<span class="token punctuation">.</span>__ob__<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 默认最外层的data必须是一个对象</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// value有可能是对象</span>
  <span class="token keyword">let</span> childOb <span class="token operator">=</span> <span class="token function">observe</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 对于属性值是对象的，也需要递归观测</span>
  <span class="token comment">// let dep = new Dep(); </span>

  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// if (Dep.target) {</span>
        <span class="token comment">// dep.depend(); </span>

        <span class="token comment">// childOb（Observer实例）有值就代表value可能是数组，可能是纯对象</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>childOb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">//对于 { arr:[1,2,4] } ，数组[1,2,4]的dep也需要收集watcher</span>
          childOb<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 对于[1,2,4,[5,6,7]]这种多维数组，我们需要循环收集watcher</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">dependArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

      <span class="token punctuation">}</span>
      <span class="token comment">// return value;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// set(newV) {</span>
    <span class="token comment">//   if (newV !== value) {</span>
    <span class="token comment">//     observe(newV);</span>
    <span class="token comment">//     value = newV;</span>
    <span class="token comment">//     dep.notify();</span>
    <span class="token comment">//   }</span>
    <span class="token comment">// },</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 对于属性的值是多维数组的，需要递归收集watcher</span>
<span class="token keyword">function</span> <span class="token function">dependArray</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> value<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// current是数组里面的，可能还是数组 [[[[[]]]]]</span>
    <span class="token keyword">let</span> current <span class="token operator">=</span> value<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> 
    current<span class="token punctuation">.</span>__ob__ <span class="token operator">&amp;&amp;</span> current<span class="token punctuation">.</span>__ob__<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">dependArray</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">数组的依赖收集</p> <p>对于对象类型的值 数组<code>([])</code>或对象<code>({})</code>在进行观测（<code>Observer</code>）时，会在<code>Observer</code>实例上增加以下两个属性：</p> <ul><li>1、<code>this.dep = new Dep()</code> 增加<code>dep</code>属性，之后数组做依赖收集(收集<code>watcher</code>)会用到，对象新增属性定义响应式时触发更新会用到。</li> <li>2、增加不可枚举的<code>__ob__</code>属性<div class="language-js extra-class"><pre class="language-js"><code>Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span><span class="token string">'__ob__'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
  <span class="token literal-property property">value</span><span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token comment">// 观测当前值的`Observer`实例</span>
  <span class="token literal-property property">enumerable</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 不能被枚举 不能被循环</span>
  <span class="token literal-property property">configurable</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token comment">// 不能删除此属性</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span> 
</code></pre></div><code>__ob__</code>属性作用如下：
<ul><li>1、为了在数组劫持方法中有新增值的时候拿到观测的<code>ob</code>实例，调用<code>ob</code>实例原型上的<code>observeArray</code>对新增的值进行递归观测。</li> <li>2、当调用数组变异方法改变数组时，执行<code>ob.dep.notify()</code>方法，更新视图</li> <li>3、对象新增属性需要定义响应式的时候需要用到。
对于属性值是数组的数据，需要给观测数组的<code>Observer</code>实例初始化一个<code>dep</code>，当获取属性走到<code>get</code>方法中时，我们让数组的<code>dep</code>也对<code>watcher</code>做依赖收集，调用数组变异方法修改数组时，就能触发数组的<code>dep</code>循环执行<code>watcher.update</code>方法更新视图。对于数组中嵌套数组的（多维数组），还需要递归收集<code>watcher</code>，这样才能在只修改内部数组时，也触发视图更新。</li></ul></li></ul></div> <h2 id="数组的派发更新"><a href="#数组的派发更新" class="header-anchor">#</a> 数组的派发更新</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/observer/array.js</span>

methods<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">method</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  arrayMethods<span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* 
    const res = oldArrayPrototype[method].call(this, ...args);
    let ob = this.__ob__;
    let inserted;
    switch (method) {
      case &quot;push&quot;:
      case &quot;unshift&quot;:
        inserted = args;
        break;
      case &quot;splice&quot;:
        inserted = args.slice(2);
      default:
        break;
    }
    if (inserted) ob.observeArray(inserted); 
    
    */</span>

    <span class="token comment">// 数组改变，触发视图更新</span>
    ob<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> res
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="对象新增属性的响应式原理"><a href="#对象新增属性的响应式原理" class="header-anchor">#</a> 对象新增属性的响应式原理</h2> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>对于对象的新增属性，<code>Vue</code>是观测不到的，所以当新增属性改变时，数据会更新，但是视图并不会更新。如果想要对象新增的属性也响应式的变化，就要用到<code>$set</code>方法来给对象新增属性。</p> <p><code>$set(target,propertyName/index,value)</code>就是用到了给对象类型的数据添加的<code>__ob__</code>属性，拿到观测当前对象的<code>ob</code>实例(<code>target.__ob__</code>)，再通过<code>ob</code>实例拿到当前观测的对象(<code>ob.value</code>)，调用<code>defineReactive(ob.value, key, val)</code>方法，将新增属性也定义成响应式的，最后通过给<code>ob</code>实例增加的<code>dep</code>触发视图更新。</p></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">5/24/2023, 11:37:36 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/vue/mount.html" class="prev">
        Vue 初始化渲染源码解析
      </a></span> <span class="next"><a href="/vue/nextTick.html">
        Vue 异步更新源码解析
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.acb235b1.js" defer></script><script src="/assets/js/2.d372d77b.js" defer></script><script src="/assets/js/1.37fa4b6c.js" defer></script><script src="/assets/js/114.ffe9fe06.js" defer></script>
  </body>
</html>
